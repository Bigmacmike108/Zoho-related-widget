<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Related Contacts</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 13px;
            color: #333;
            background: #fff;
            padding: 0;
        }

        .widget-container {
            width: 100%;
            height: 100vh;
            overflow: auto;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
            font-size: 14px;
        }

        .error {
            padding: 20px;
            color: #d32f2f;
            background: #ffebee;
            border-left: 4px solid #d32f2f;
            margin: 10px;
        }

        .no-records {
            padding: 40px 20px;
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .contacts-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }

        .contacts-table thead {
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .contacts-table th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .contacts-table th:hover {
            background-color: #eeeeee;
        }

        .contacts-table th.sortable::after {
            content: ' ⇅';
            opacity: 0.3;
            font-size: 14px;
        }

        .contacts-table th.sort-asc::after {
            content: ' ↑';
            opacity: 1;
            color: #1976d2;
        }

        .contacts-table th.sort-desc::after {
            content: ' ↓';
            opacity: 1;
            color: #1976d2;
        }

        .contacts-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            font-size: 13px;
        }

        .contacts-table tbody tr {
            transition: background-color 0.2s;
        }

        .contacts-table tbody tr:hover {
            background-color: #f9f9f9;
        }

        .contact-name {
            font-weight: 500;
            color: #1976d2;
            cursor: pointer;
            text-decoration: none;
        }

        .contact-name:hover {
            text-decoration: underline;
            color: #1565c0;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-active {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-inactive {
            background: #ffebee;
            color: #c62828;
        }

        .record-count {
            padding: 12px 16px;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <div id="loading" class="loading">Loading related contacts...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="content" style="display: none;">
            <div id="recordCount" class="record-count"></div>
            <table class="contacts-table">
                <thead>
                    <tr>
                        <th class="sortable" data-column="fullName" data-type="string">Full Name</th>
                        <th class="sortable" data-column="Email" data-type="string">Email</th>
                        <th class="sortable" data-column="Phone" data-type="string">Phone</th>
                        <th class="sortable" data-column="Active" data-type="boolean">Active</th>
                        <th class="sortable" data-column="Age" data-type="number">Age</th>
                    </tr>
                </thead>
                <tbody id="contactsBody">
                </tbody>
            </table>
        </div>
        <div id="noRecords" class="no-records" style="display: none;">
            No related contacts found
        </div>
    </div>

    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>
    <script>
        // Initialize the widget
        ZOHO.embeddedApp.on("PageLoad", function(data) {
            console.log("PageLoad event fired with data:", data);
            initWidget(data);
        });

        ZOHO.embeddedApp.init();

        let allContacts = []; // Store all contacts for sorting
        let currentSort = { column: 'fullName', direction: 'asc' };

        async function initWidget(data) {
            try {
                console.log("initWidget called");
                console.log("Raw data:", JSON.stringify(data, null, 2));
                
                // Get the current Account record ID
                let accountId;
                
                // Handle different data structures
                if (data.EntityId) {
                    console.log("EntityId type:", typeof data.EntityId);
                    console.log("Is array?", Array.isArray(data.EntityId));
                    console.log("EntityId value:", data.EntityId);
                    
                    // EntityId can be either a string (related list) or array (button)
                    if (Array.isArray(data.EntityId)) {
                        accountId = data.EntityId[0];
                    } else {
                        accountId = data.EntityId;
                    }
                } else if (data.Entity && data.id) {
                    accountId = data.id;
                }

                console.log("Extracted Account ID:", accountId);
                console.log("Account ID type:", typeof accountId);

                if (!accountId) {
                    showError("Unable to retrieve Account ID. Data received: " + JSON.stringify(data));
                    return;
                }

                // Fetch related contacts
                await fetchRelatedContacts(accountId);

            } catch (error) {
                console.error("Initialization error:", error);
                showError("Failed to initialize widget: " + (error.message || JSON.stringify(error)));
            }
        }

        async function fetchRelatedContacts(accountId) {
            try {
                console.log("Fetching contacts for account:", accountId);
                
                // Use searchRecords API instead of COQL
                const config = {
                    Entity: "Contacts",
                    Type: "criteria",
                    Query: `(Account_Name:equals:${accountId})`,
                    page: 1,
                    per_page: 200
                };

                console.log("Search config:", config);
                const response = await ZOHO.CRM.API.searchRecord(config);
                
                console.log("API Response:", response);
                console.log("Response status:", response.status);
                
                // Handle 204 no content - means no contacts found
                if (response.status === 204 || (response.statusText && response.statusText.toLowerCase() === "nocontent")) {
                    showNoRecords();
                    return;
                }
                
                if (response.data) {
                    displayContacts(response.data);
                } else if (response.info && response.info.count === 0) {
                    showNoRecords();
                } else {
                    showError("Failed to fetch contacts: " + JSON.stringify(response));
                }

            } catch (error) {
                console.error("Fetch error:", error);
                showError("Error fetching contacts: " + (error.message || JSON.stringify(error)));
            }
        }

        function displayContacts(contacts) {
            const tbody = document.getElementById("contactsBody");
            const loading = document.getElementById("loading");
            const content = document.getElementById("content");
            const recordCount = document.getElementById("recordCount");

            // Store contacts globally for sorting
            allContacts = contacts;

            // Clear existing content
            tbody.innerHTML = "";

            if (!contacts || contacts.length === 0) {
                showNoRecords();
                return;
            }

            // Display record count
            recordCount.textContent = `${contacts.length} Contact${contacts.length !== 1 ? 's' : ''}`;

            // Add click handlers to sortable headers
            document.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.getAttribute('data-column');
                    const type = this.getAttribute('data-type');
                    sortContacts(column, type);
                });
            });

            // Render the contacts
            renderContacts(contacts);

            // Show content, hide loading
            loading.style.display = "none";
            content.style.display = "block";
        }

        function renderContacts(contacts) {
            const tbody = document.getElementById("contactsBody");
            tbody.innerHTML = "";

            // Process each contact for display
            const processedContacts = contacts.map(contact => {
                const fullName = `${contact.First_Name || ''} ${contact.Last_Name || ''}`.trim() || '—';
                const email = contact.Email || '—';
                const phone = contact.Phone || '—';
                const isActive = contact.Active === true || contact.Active === 'true';
                const age = contact.Age !== null && contact.Age !== undefined ? contact.Age : '—';
                
                return {
                    ...contact,
                    fullName,
                    email,
                    phone,
                    isActive,
                    age,
                    displayActive: contact.Active !== null && contact.Active !== undefined
                        ? `<span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">${isActive ? 'Active' : 'Inactive'}</span>`
                        : '—'
                };
            });

            // Create table rows
            processedContacts.forEach(contact => {
                const row = document.createElement("tr");
                
                row.innerHTML = `
                    <td><a href="#" class="contact-name" data-contact-id="${contact.id}">${escapeHtml(contact.fullName)}</a></td>
                    <td>${escapeHtml(contact.email)}</td>
                    <td>${escapeHtml(contact.phone)}</td>
                    <td>${contact.displayActive}</td>
                    <td>${escapeHtml(contact.age.toString())}</td>
                `;

                tbody.appendChild(row);
            });

            // Add click handlers to contact name links
            document.querySelectorAll('.contact-name').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const contactId = this.getAttribute('data-contact-id');
                    openContactRecord(contactId);
                });
            });
        }

        function sortContacts(column, type) {
            // Update sort direction
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }

            // Update header indicators
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            const activeHeader = document.querySelector(`th[data-column="${column}"]`);
            activeHeader.classList.add(`sort-${currentSort.direction}`);

            // Sort the contacts
            const sortedContacts = [...allContacts].sort((a, b) => {
                let aVal, bVal;

                if (column === 'fullName') {
                    aVal = `${a.First_Name || ''} ${a.Last_Name || ''}`.trim().toLowerCase();
                    bVal = `${b.First_Name || ''} ${b.Last_Name || ''}`.trim().toLowerCase();
                } else {
                    aVal = a[column];
                    bVal = b[column];
                }

                // Handle null/undefined values
                if (aVal === null || aVal === undefined) aVal = '';
                if (bVal === null || bVal === undefined) bVal = '';

                let comparison = 0;
                
                if (type === 'number') {
                    comparison = (parseFloat(aVal) || 0) - (parseFloat(bVal) || 0);
                } else if (type === 'boolean') {
                    const aBool = aVal === true || aVal === 'true';
                    const bBool = bVal === true || bVal === 'true';
                    comparison = aBool === bBool ? 0 : (aBool ? -1 : 1);
                } else {
                    comparison = aVal.toString().localeCompare(bVal.toString());
                }

                return currentSort.direction === 'asc' ? comparison : -comparison;
            });

            renderContacts(sortedContacts);
        }

        async function openContactRecord(contactId) {
            try {
                // Open the contact record in a new tab
                await ZOHO.CRM.UI.Record.open({
                    Entity: "Contacts",
                    RecordID: contactId
                });
            } catch (error) {
                console.error("Error opening contact record:", error);
                // Fallback: construct URL manually
                const baseUrl = window.location.origin;
                window.open(`${baseUrl}/crm/EntityInfo.do?module=Contacts&id=${contactId}`, '_blank');
            }
        }

        function showNoRecords() {
            document.getElementById("loading").style.display = "none";
            document.getElementById("noRecords").style.display = "block";
        }

        function showError(message) {
            const loading = document.getElementById("loading");
            const errorDiv = document.getElementById("error");
            
            loading.style.display = "none";
            errorDiv.textContent = message;
            errorDiv.style.display = "block";
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>